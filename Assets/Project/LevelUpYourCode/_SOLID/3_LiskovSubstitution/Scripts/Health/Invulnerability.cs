using UnityEngine;

namespace DesignPatterns.LSP
{
    /// <summary>
    /// Health 컴포넌트에서 데미지를 일시적으로 무효화할 수 있는 컴포넌트
    /// 지정된 시간 동안 무적 상태를 유지합니다.
    /// </summary>
    [RequireComponent(typeof(Health))]
    public class Invulnerability : MonoBehaviour
    {
        [Header("시각 효과")]
        [Tooltip("파워업이 활성화되어 있음을 나타내는 파티클 효과")]
        [SerializeField] private ParticleSystem m_ParticleSystem;

        private float  m_Duration = 2f;
        private float  m_Timer;
        private Health m_Health;

        public float Duration
        {
            get => m_Duration;
            set => m_Duration = value;
        }

        private void Awake()
        {
            m_Health = GetComponent<Health>();
            m_ParticleSystem.Stop();
        }

        private void Update()
        {
            // 무적이 활성화되어 있으면 타이머 감소
            if (m_Health.IsInvulnerable)
            {
                m_Timer -= Time.deltaTime;

                // 타이머가 만료되면 무적 비활성화
                if (m_Timer <= 0)
                {
                    m_Health.IsInvulnerable = false;

                    Debug.Log("무적 비활성화");

                    if (m_ParticleSystem != null)
                        m_ParticleSystem.Stop();
                }
            }
        }

        /// <summary>
        /// 지정된 시간 동안 무적을 활성화합니다.
        /// </summary>
        /// <param name="duration">무적 지속 시간 (초)</param>
        public void Activate(float duration)
        {
            // 타이머 설정 및 무적 활성화
            m_Timer                     = duration;
            m_Health.IsInvulnerable = true;

            Debug.Log("무적 활성화");

            if (m_ParticleSystem != null)
            {
                m_ParticleSystem.Play();
            }
        }
    }
}